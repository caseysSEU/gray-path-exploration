<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Interactive Graph Visualization</title>
    <script type="module">
        import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";

        const graph = {
            vertices: [
                {id: 0, x: 100, y: 100},
                {id: 1, x: 100, y: 150},
                {id: 2, x: 100, y: 200},
                {id: 3, x: 100, y: 250},
                {id: 4, x: 150, y: 250},
                {id: 5, x: 100, y: 300},
                {id: 6, x: 150, y: 300},
                {id: 7, x: 100, y: 350},
                {id: 8, x: 150, y: 350},
                {id: 9, x: 100, y: 400},
                {id: 10, x: 150, y: 400},
                {id: 11, x: 200, y: 400},
                {id: 12, x: 100, y: 450},
                {id: 13, x: 150, y: 450},
                {id: 14, x: 200, y: 450},
                {id: 15, x: 100, y: 500},
                {id: 16, x: 150, y: 500},
                {id: 17, x: 200, y: 500},
                {id: 18, x: 100, y: 550},
                {id: 19, x: 150, y: 550},
                {id: 20, x: 200, y: 550},
                {id: 21, x: 250, y: 550},
                {id: 22, x: 275, y: 525},
                {id: 23, x: 100, y: 600},
                {id: 24, x: 150, y: 600},
                {id: 25, x: 200, y: 600},
                {id: 26, x: 250, y: 600},
                {id: 27, x: 275, y: 575}
            ],
            edges: [
                {source: 0, target: 1},
                {source: 1, target: 2},
                {source: 2, target: 3},
                {source: 3, target: 4},
                {source: 3, target: 5},
                {source: 6, target: 4},
                {source: 6, target: 5},
                {source: 6, target: 8},
                {source: 7, target: 5},
                {source: 7, target: 8},
                {source: 7, target: 9},
                {source: 8, target: 10},
                {source: 9, target: 10},
                {source: 9, target: 12},
                {source: 10, target: 11},
                {source: 10, target: 13},
                {source: 11, target: 14},
                {source: 12, target: 13},
                {source: 12, target: 15},
                {source: 13, target: 14},
                {source: 13, target: 16},
                {source: 14, target: 17},
                {source: 10, target: 13},
                {source: 15, target: 16},
                {source: 16, target: 17},
                {source: 15, target: 18},
                {source: 16, target: 19},
                {source: 17, target: 20},
                {source: 19, target: 20},
                {source: 18, target: 19},
                {source: 20, target: 21},
                {source: 21, target: 22},
                {source: 18, target: 23},
                {source: 19, target: 24},
                {source: 20, target: 25},
                {source: 23, target: 24},
                {source: 24, target: 25},
                {source: 25, target: 26},
                {source: 21, target: 26},
                {source: 26, target: 27},
                {source: 22, target: 27}
            ]
        };

        const width = 300;
        const height = 900;
        const svg = d3.select("#graph")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .attr("class", "scrollable-graph");

        const usedEdges = new Set();
        const vertexConnections = new Map();
        const selectedEdges = new Set();

        graph.vertices.forEach(v => vertexConnections.set(v.id, 0));

        const edges = svg.selectAll("line")
            .data(graph.edges)
            .enter()
            .append("line")
            .attr("x1", d => graph.vertices.find(v => v.id === d.source).x)
            .attr("y1", d => graph.vertices.find(v => v.id === d.source).y)
            .attr("x2", d => graph.vertices.find(v => v.id === d.target).x)
            .attr("y2", d => graph.vertices.find(v => v.id === d.target).y)
            .attr("stroke", "lightgray")
            .attr("stroke-width", 1)
            .attr("class", "edge")
            .attr("data-source", d => d.source)
            .attr("data-target", d => d.target);

        const vertices = svg.selectAll("circle")
            .data(graph.vertices)
            .enter()
            .append("circle")
            .attr("cx", d => d.x)
            .attr("cy", d => d.y)
            .attr("r", 15)
            .attr("fill", "lightblue")
            .attr("class", "vertex")
            .attr("data-id", d => d.id);

        svg.selectAll(".vertex-label")
            .data(graph.vertices)
            .enter()
            .append("text")
            .attr("x", d => d.x)
            .attr("y", d => d.y)
            .attr("text-anchor", "middle")
            .attr("dy", ".3em")
            .text(d => d.id)
            .attr("pointer-events", "none")
            .attr("fill", "black");

        const selectedPath = [];
        const pathList = d3.select("#path-list");

        function findEdgeInSet(set, source, target) {
            return Array.from(set).find(edge => 
                (edge.source === source && edge.target === target) ||
                (edge.source === target && edge.target === source)
            );
        }

        function removeEdgeFromSet(set, source, target) {
            const edge = findEdgeInSet(set, source, target);
            if (edge) {
                set.delete(edge);
            }
        }

        function updateEdgeVisibility() {
            edges.attr("stroke", "lightgray")
                 .attr("stroke-width", 1);

            selectedEdges.forEach(edge => {
                edges.filter(d => 
                    (d.source === edge.source && d.target === edge.target) ||
                    (d.source === edge.target && d.target === edge.source)
                )
                .attr("stroke", "red")
                .attr("stroke-width", 4);
            });

            graph.vertices.forEach(v => {
                const connections = vertexConnections.get(v.id);
                if (connections >= 2) {
                    edges.filter(d => 
                        (d.source === v.id || d.target === v.id) &&
                        !Array.from(selectedEdges).some(edge => 
                            (edge.source === d.source && edge.target === d.target) ||
                            (edge.source === d.target && edge.target === d.source)
                        )
                    )
                    .attr("stroke", "rgba(200,200,200,0.2)")
                    .attr("stroke-width", 0.5);
                }
            });
        }

        vertices.on("click", function() {
            const vertexId = parseInt(d3.select(this).attr("data-id"));
            const isSelected = d3.select(this).classed("selected");

            if (selectedPath.length > 0 && vertexId === selectedPath[selectedPath.length - 1]) {
                // Remove vertex selection
                svg.selectAll(".vertex")
                    .filter(d => d.id === vertexId)
                    .classed("selected", false);

                if (selectedPath.length > 1) {
                    const previousVertex = selectedPath[selectedPath.length - 2];
                    
                    // Remove the edge from both sets
                    removeEdgeFromSet(usedEdges, previousVertex, vertexId);
                    removeEdgeFromSet(selectedEdges, previousVertex, vertexId);
                    
                    // Update vertex connections
                    vertexConnections.set(previousVertex, 
                        vertexConnections.get(previousVertex) - 1);
                    vertexConnections.set(vertexId, 
                        vertexConnections.get(vertexId) - 1);
                }

                selectedPath.pop();
                pathList.html(selectedPath.join(" → "));
                updateEdgeVisibility();
                return;
            }

            if (isSelected) return;

            if (selectedPath.length === 0 || 
                graph.edges.some(e => 
                    ((e.source == selectedPath[selectedPath.length-1] && e.target == vertexId) ||
                    (e.target == selectedPath[selectedPath.length-1] && e.source == vertexId)) &&
                    vertexConnections.get(vertexId) < 2 &&
                    vertexConnections.get(selectedPath[selectedPath.length-1]) < 2
                )) {
                
                d3.select(this).classed("selected", true);
                selectedPath.push(vertexId);
                
                if (selectedPath.length > 1) {
                    const lastVertices = selectedPath.slice(-2);
                    const newEdge = {
                        source: lastVertices[0],
                        target: lastVertices[1]
                    };
                    usedEdges.add(newEdge);
                    selectedEdges.add(newEdge);
                    
                    vertexConnections.set(lastVertices[0], 
                        (vertexConnections.get(lastVertices[0]) || 0) + 1);
                    vertexConnections.set(lastVertices[1], 
                        (vertexConnections.get(lastVertices[1]) || 0) + 1);
                }

                pathList.html(selectedPath.join(" → "));
                updateEdgeVisibility();
            }
        });
    </script>
    <style>
        body {
            display: flex;
            margin: 0;
            height: 100vh;
        }
        #graph-container {
            width: 70%;
            overflow-y: auto;
        }
        #path-container {
            width: 30%;
            padding: 20px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        .vertex {
            cursor: pointer;
            transition: fill 0.3s;
        }
        .vertex.selected {
            fill: orange;
        }
        .scrollable-graph {
            display: block;
        }
    </style>
</head>
<body>
    <div id="graph-container">
        <div id="graph"></div>
    </div>
    <div id="path-container">
        Current Path: <span id="path-list"></span>
    </div>
</body>
</html>